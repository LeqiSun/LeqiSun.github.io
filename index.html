<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Coding Sun Coding Moon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="孙乐奇的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Coding Sun Coding Moon">
<meta property="og:url" content="http://lequsun.com/index.html">
<meta property="og:site_name" content="Coding Sun Coding Moon">
<meta property="og:description" content="孙乐奇的个人博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Coding Sun Coding Moon">
<meta name="twitter:description" content="孙乐奇的个人博客">
  
    <link rel="alternate" href="/atom.xml" title="Coding Sun Coding Moon" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Coding Sun Coding Moon</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">一个还算比较勤奋的CodeMan...嗯嗯，肯定是这样！</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://lequsun.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-ConcurrentHashMap" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/java/ConcurrentHashMap/" class="article-date">
  <time datetime="2016-10-20T12:00:00.000Z" itemprop="datePublished">2016-10-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/java/ConcurrentHashMap/">ConcurrentHashMap，synchronizedMap分析比较</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>多线程情况下使用Map集合时，不能使用常用的HashMap，因为HashMap不是线程安全类，这里就要使用线程安全的Map实现类，当然我们首选ConcurrentHashMap。</p>
<p>Map的线程安全实现方式有三种，分别为Hashtable、Collections.synchronizedMap和ConcurrentHashMap</p>
<p>###Hashtable<br>Hashtable的效率比较差，因为它是在方法上使用synchronized来保证线程安全，粒度比较粗，当有多个线程激烈竞争时，效率非常低下，当一个线程访问Hashtable的同步方法时，其它线程访问Hashtable的同步方法会进入阻塞状态，即当某一个线程添加元素时，其他线程不能添加元素，或是get元素，如果并发量大的话，效率会非常低下，所以不推荐使用。</p>
<p>###synchronizedMap<br>synchronizedMap是Collections的内部类，它的线程安全实现方式跟Hashtable比较像，粒度也很粗，使用了一个互斥变量，对其加锁进行控制，性能和Hashtable基本一样，所以也不推荐<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> m.get(key);&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> m.put(key, value);&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>###ConcurrentHashMap<br>更好的选择是ConcurrentHashMap，它是在jdk1.5里添加的，它使用了一种完全不同的加锁策略来提供更高的并发性和伸缩性，ConcurrentHashMap并不是将每个方法都在同一个锁上同步并使得每次只能有一个线程访问容器，而是使用一种粒度更细的加锁机制来实现更程度的共享，在JDK8之前使用的是<strong>Segment分段锁机制</strong>，JDK8使用的是CAS（Compare And Swap）和Synchronized来保证并发更新的安全，可以看看JDK8里的部分代码<br>Node</p>
<hr>
<p>####Table初始化<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</div><div class="line">    Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</div><div class="line">    <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</div><div class="line">            Thread.yield(); <span class="comment">// lost initialization race; just spin</span></div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</div><div class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</div><div class="line">                    table = tab = nt;</div><div class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                sizeCtl = sc;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> tab;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，在初始化table时，使用的是CAS机制，可以看到有一个变量<em>sizeCtl</em>，初始化的值是0，当小于0时，表明有其它线程正在操作table，所以执行Thread.yield()让出CPU时间片，然后只会有一个线程能修改sizeCtl成-1并且进行table初始化，这样就能保证table的安全初始化。</p>
<hr>
<p>####put操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function">Node&lt;K,V&gt; <span class="title">tabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i, Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());</div><div class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</div><div class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</div><div class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</div><div class="line">            tab = initTable();</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>, <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</div><div class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</div><div class="line">            tab = helpTransfer(tab, f);</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            V oldVal = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">synchronized</span> (f) &#123;</div><div class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</div><div class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</div><div class="line">                        binCount = <span class="number">1</span>;</div><div class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</div><div class="line">                            K ek;</div><div class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</div><div class="line">                                ((ek = e.key) == key ||</div><div class="line">                                 (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</div><div class="line">                                oldVal = e.val;</div><div class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</div><div class="line">                                    e.val = value;</div><div class="line">                                <span class="keyword">break</span>;</div><div class="line">                            &#125;</div><div class="line">                            Node&lt;K,V&gt; pred = e;</div><div class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</div><div class="line">                                pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>);</div><div class="line">                                <span class="keyword">break</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</div><div class="line">                        Node&lt;K,V&gt; p;</div><div class="line">                        binCount = <span class="number">2</span>;</div><div class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key, value)) != <span class="keyword">null</span>) &#123;</div><div class="line">                            oldVal = p.val;</div><div class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</div><div class="line">                                p.val = value;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</div><div class="line">                    treeifyBin(tab, i);</div><div class="line">                <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</div><div class="line">                    <span class="keyword">return</span> oldVal;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    addCount(<span class="number">1L</span>, binCount);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，在插入一个不存在的key时，使用的也是CAS机制，对于已存在的key，使用synchronized关键字对旧的Node节点加锁，继而进行相关操作</p>
<p>先就到这里，有时间再继续深究一下红黑树，上面就用到了这个。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lequsun.com/java/ConcurrentHashMap/" data-id="cixwzd9mp0002zcfn0ad4gvza" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Concurrency/">Concurrency</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Set/">Set</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-jpa_name_strategy" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/spring/jpa_name_strategy/" class="article-date">
  <time datetime="2016-08-11T13:30:00.000Z" itemprop="datePublished">2016-08-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/spring/">spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/spring/jpa_name_strategy/">Spring Data JPA中设置实体驼峰类型字段名到数据库下划线类型字段的映射</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近在新项目中用上了Spring Data JPA，用来替换以前项目用的MyBatis，使用的版本是1.10.2，Hibernate依赖使用的版本是5.2.0 Final。</p>
<p>首先，按照网上搜到的配置基本OK了，项目能启动，以下是实体管理器的xml配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 实体管理器 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"entityManagerFactory"</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"packagesToScan"</span> <span class="attr">value</span>=<span class="string">"com.lucas.domain.domain"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jpaVendorAdapter"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jpaDialect"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.vendor.HibernateJpaDialect"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jpaProperties"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">props</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.show_sql"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.format_sql"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.ejb.naming_strategy"</span>&gt;</span></div><div class="line">                com.lucas.strategy.MyImprovedNamingStrategy</div><div class="line">            <span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">props</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>自己定义了一个Naming Strategy，MyImprovedNamingStrategy，用于映射Java实体字段名和数据库字段名，但是执行查询时，打印出的Sql并没有按照Naming Strategy来修改，断点也没进，网上查到的资料基本都是说这样写，但是总是没效果，自己在源码里调试，也没调试出个所以然。</p>
<p>几经周折才了解到Hibernate从4升到5要做的修改，其中一点是Naming Strategy接口的修改，已经由ImprovedNamingStrategy替换到PhysicalNamingStrategy了，自己继承了一个实现类后，重写了Column的相关方法，然后重启就启作用了。</p>
<p>但是，这个接口有个问题，对于已经添加了@Column注解并且设置了name的字段，也会进入这个Naming Strategy去处理，假设数据库的某些字段就是驼峰的，那么这个Naming Strategy就没法好好处理了</p>
<p>在这里，Hibernate还提供了一个Naming Strategy的接口，叫做ImplicitNamingStrategy，自己写了个继承，代码如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</div><div class="line"><span class="keyword">import</span> org.hibernate.boot.model.naming.Identifier;</div><div class="line"><span class="keyword">import</span> org.hibernate.boot.model.naming.ImplicitBasicColumnNameSource;</div><div class="line"><span class="keyword">import</span> org.hibernate.boot.model.naming.ImplicitNamingStrategyJpaCompliantImpl;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 此命名策略不会操作实体内加了<span class="doctag">@Column</span>注解的字段，PhysicalNamingStrategy的命名策略实现类则会操作</div><div class="line"> * Created by Lucas on 7/29/2016</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyImplicitNamingStrategy</span> <span class="keyword">extends</span> <span class="title">ImplicitNamingStrategyJpaCompliantImpl</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Identifier <span class="title">determineBasicColumnName</span><span class="params">(ImplicitBasicColumnNameSource source)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> convert(source);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Identifier <span class="title">convert</span><span class="params">(ImplicitBasicColumnNameSource source)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (StringUtils.isBlank(transformAttributePath(source.getAttributePath()))) &#123;</div><div class="line">            <span class="keyword">return</span> toIdentifier(transformAttributePath(source.getAttributePath()), </div><div class="line">                                source.getBuildingContext());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String regex = <span class="string">"([a-z])([A-Z])"</span>;</div><div class="line">        String replacement = <span class="string">"$1_$2"</span>;</div><div class="line">        String newName = transformAttributePath(source.getAttributePath())</div><div class="line">                .replaceAll(regex, replacement).toLowerCase();</div><div class="line">        <span class="keyword">return</span> toIdentifier(newName, source.getBuildingContext());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>实体管理器xml配置修改如下<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 实体管理器 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"entityManagerFactory"</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"packagesToScan"</span> <span class="attr">value</span>=<span class="string">"com.lucas.domain.domain"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jpaVendorAdapter"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jpaDialect"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.vendor.HibernateJpaDialect"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jpaProperties"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">props</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.show_sql"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.format_sql"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!--注意下面的Naming Strategy的修改--&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.implicit_naming_strategy"</span>&gt;</span></div><div class="line">                com.lucas.strategy.MyImplicitNamingStrategy</div><div class="line">            <span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">props</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这样，就完美解决了字段名的映射问题，普通的字段可以这个Naming Strategy来映射，特殊的字段可以用@Column(name=”数据库里的字段名称”)</p>
<p>另外此Naming Strategy中也可以配置表名的映射等等</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lequsun.com/spring/jpa_name_strategy/" data-id="cixwzd9na0008zcfnxn1n4eqx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hibernate/">Hibernate</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Data-JPA/">Spring Data JPA</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-java_spring_session" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/spring/java_spring_session/" class="article-date">
  <time datetime="2016-06-05T15:03:00.000Z" itemprop="datePublished">2016-06-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/spring/">spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/spring/java_spring_session/">使用spring session时，关于session的共享设置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>前些天，针对当前的项目，开了个子项目，准备用个二级域名，要求账号用一套，然后就牵扯到session共享的问题，开始没考虑到spring session，只考虑到tomcat层面的，google了一下后，说配置一下context。</p>
<p>具体是<br>在项目中webapp添加文件夹META-INF，然后添加个文件context.xml，内容为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">useHttpOnly</span>=<span class="string">"true"</span> <span class="attr">sessionCookiePath</span>=<span class="string">"/"</span> <span class="attr">sessionCookieDomain</span>=<span class="string">".XXXX.com"</span> /&gt;</span></div></pre></td></tr></table></figure></p>
<p>但是启动项目后，发现两个地址下的SESSIONID不一样，domain也不一样，然后用户登录信息就不会公用了，后来不管怎么配置都不会生效，让人很苦恼！</p>
<p>后来了解到我们的项目用的是spring session，所有的用户session都存在redis中了，所以才想到，session的生成逻辑应该是已经被spring session托管了。而后经过大牛的指点，并且看了下spring session的源码，还有spring session中关于session的文档，<a href="http://docs.spring.io/spring-session/docs/current/reference/html5/guides/custom-cookie.html" target="_blank" rel="external">《Spring Session - Custom Cookie》</a>，spring session在创建session时，是没有设置domain的，那么就会用默认的域名设置。</p>
<p>spring session的开发人员也考虑到了这个，所以在DefaultCookieSerializer（该类是用来处理session的）中设置了一些私有变量和set方法，有domainName和domainNamePattern（正则表达式）等等，domainName是用来设置session的domain，domainNamePattern是用来根据request里的serverName来匹配出对应的domainName。</p>
<p>因为有set方法，我们可以采用注入的方式，在spring session的配置文件中，将domainName或domainNamePattern注入进去</p>
<p>注入domainName方式，可以直接设定对应的顶级域名，比如abc.com<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.session.web.http.DefaultCookieSerializer"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"domainName"</span> <span class="attr">value</span>=<span class="string">"abc.com"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>注入domainNamePattern方式，可以设定一串正则表达式，用来获取到顶级域名，这里注进去的value值为spring session官方提供的<strong>^.+?\\.(\\w+\\.[a-z]+)$</strong>，不过我测试时，发现获取不到顶级域名，这个待继续研究，目前项目中可以采取上一种方式直接写死domainName<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.session.web.http.DefaultCookieSerializer"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"domainNamePattern"</span> <span class="attr">value</span>=<span class="string">"^.+?\\.(\\w+\\.[a-z]+)$"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这样，最终就解决了二级域名下的session共享问题，之前的关于tomcat的context配置就可以去掉了，因为这里不需要的了</p>
<p>That’s All，也辛辛苦苦写了不少，希望能帮助到大家，如果有问题，还望大家指出，谢谢！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lequsun.com/spring/java_spring_session/" data-id="cixwzd9n00005zcfn5g51wrf5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/session/">session</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/">spring</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-java_socket" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/java/java_socket/" class="article-date">
  <time datetime="2016-05-28T04:09:00.000Z" itemprop="datePublished">2016-05-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/java/java_socket/">Java中关于socket的学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>前言</strong><br>使用Java这么久，还没有了解过socket呢，只知道是一种可以双向通信的数据交换技术，起源于UNIX，后来各大操作系统都开始支持socket了。<br>于是本人呢，就花些时间学习了一下。所以，直接上代码！</p>
<hr>
<p>创建socket处理类 SocketOperate<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.BufferedReader;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.InputStreamReader;</div><div class="line"><span class="keyword">import</span> java.io.OutputStream;</div><div class="line"><span class="keyword">import</span> java.net.Socket;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by SunLeqi on 4/27/2016</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SocketOperate</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Socket socket;</div><div class="line">    <span class="comment">//该线程所处理的Socket所对应的输入流</span></div><div class="line">    <span class="keyword">private</span> BufferedReader br = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> InputStreamReader reader = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    SocketOperate(Socket socket) <span class="keyword">throws</span> IOException&#123;</div><div class="line">        <span class="keyword">this</span>.socket = socket;</div><div class="line">        reader = <span class="keyword">new</span> InputStreamReader(<span class="keyword">this</span>.socket.getInputStream(),<span class="string">"utf-8"</span>);</div><div class="line">        br = <span class="keyword">new</span> BufferedReader(reader);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//采用循环不断从socket中读取客户端发送过来的数据</span></div><div class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</div><div class="line">                String msg = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    msg = br.readLine();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e1) &#123;</div><div class="line">                    br.close();</div><div class="line">                    reader.close();</div><div class="line">                    socket.close();</div><div class="line">                    e1.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                System.out.println(msg);</div><div class="line">                <span class="keyword">if</span> (msg == <span class="keyword">null</span>)&#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                OutputStream os = socket.getOutputStream();</div><div class="line">                os.write((<span class="string">"RESPONSE, SUCCESS, Server给Client发来消息了！ "</span>+ i + <span class="string">"\n"</span>).getBytes(<span class="string">"utf-8"</span>));</div><div class="line">                os.flush();</div><div class="line">                i++;</div><div class="line">            &#125;</div><div class="line">        &#125;<span class="keyword">catch</span> (IOException e2)&#123;</div><div class="line">            e2.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p>新建SocketThread类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.net.ServerSocket;</div><div class="line"><span class="keyword">import</span> java.net.Socket;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by SunLeqi on 4/26/2016</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SocketThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> ServerSocket serverSocket = <span class="keyword">null</span>;</div><div class="line">    SocketThread(ServerSocket serverSocket)&#123;</div><div class="line">        <span class="keyword">try</span>&#123;</div><div class="line">            <span class="keyword">if</span>(serverSocket == <span class="keyword">null</span>)&#123;</div><div class="line">                <span class="comment">//端口自定义，这里我定为9999</span></div><div class="line">                <span class="keyword">this</span>.serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">9999</span>);</div><div class="line">                System.out.println(<span class="string">"socket start"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            System.out.println(<span class="string">"SocketThread构造方法创建socket服务出错"</span>);</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="comment">//采取死循环处理数据，可以使进程一直维持，接收数据</span></div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</div><div class="line">            <span class="keyword">try</span>&#123;</div><div class="line">                <span class="keyword">if</span>(serverSocket == <span class="keyword">null</span>)&#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(serverSocket.isClosed())&#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                Socket socket = serverSocket.accept();</div><div class="line">                <span class="keyword">if</span>(socket != <span class="keyword">null</span> &amp;&amp; !socket.isClosed())&#123;</div><div class="line">                    <span class="comment">//处理接收的数据</span></div><div class="line">                    Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> SocketOperate(socket));</div><div class="line">                    t1.start();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</div><div class="line">                System.out.println(<span class="string">"SocketThread的run方法创建socket服务出错"</span>);</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//关闭socket服务</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">closeSocketServer</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span>(serverSocket != <span class="keyword">null</span> &amp;&amp; !serverSocket.isClosed())&#123;</div><div class="line">                serverSocket.close();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p>最后在web.xml中配上listener，使项目在启动的时候创建socket线程，开始接收信息<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>SocketThreadInitListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> javax.servlet.ServletContextEvent;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletContextListener;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by SunLeqi on 4/22/2016</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttendSocketListener</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> SocketThread socketThread;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent servletContextEvent)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(socketThread == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="comment">//新建线程类</span></div><div class="line">            socketThread = <span class="keyword">new</span> SocketThread(<span class="keyword">null</span>);</div><div class="line">            <span class="comment">//启动线程</span></div><div class="line">            socketThread.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent servletContextEvent)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(socketThread != <span class="keyword">null</span> &amp;&amp; !socketThread.isInterrupted())&#123;</div><div class="line">            socketThread.closeSocketServer();</div><div class="line">            socketThread.interrupt();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上是socket服务端代码</p>
<hr>
<p>以下看看客户端代码，这里可以自行采用main方法或者junit来实现，我这里是用junit测试的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.BufferedReader;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.InputStreamReader;</div><div class="line"><span class="keyword">import</span> java.io.PrintWriter;</div><div class="line"><span class="keyword">import</span> java.net.Socket;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by SunLeqi on 4/27/2016</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</div><div class="line">        Socket socket = <span class="keyword">new</span> Socket(<span class="string">"127.0.0.1"</span>,<span class="number">9999</span>);</div><div class="line">        PrintWriter os = <span class="keyword">new</span> PrintWriter(socket.getOutputStream());</div><div class="line">        BufferedReader is = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</div><div class="line">        <span class="keyword">int</span> i = <span class="number">1</span>;</div><div class="line">        <span class="keyword">while</span> (socket.isConnected())&#123;</div><div class="line">            os.print(<span class="string">"REQUEST, OK, 这条信息来自Socket客户端"</span>+<span class="string">"\n"</span>);</div><div class="line">            os.flush();</div><div class="line">            System.out.println(<span class="string">"Client:"</span>+i);</div><div class="line">            System.out.println(<span class="string">"Server:"</span>+is.readLine());</div><div class="line">            i++;</div><div class="line">            <span class="keyword">if</span>(i == <span class="number">10</span>)&#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        os.close();</div><div class="line">        is.close();</div><div class="line">        socket.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p>基本上，代码就这样了，比较简单，可以点进源码好好了解一下，也可以拓展开，尝试着写个即时通讯工具哦。<br>最后，还得安利一下IDEA，写代码真爽！！！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lequsun.com/java/java_socket/" data-id="cixwzd9n30006zcfnlqblxz4q" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/socket/">socket</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-java_interface" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/java/java_interface/" class="article-date">
  <time datetime="2016-05-19T15:35:00.000Z" itemprop="datePublished">2016-05-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/java/java_interface/">Java中的抽象类与接口</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>抽象类</strong></p>
<p>抽象类是由abstract修饰的类，并且一定包含有用abstract修饰的方法，也就是抽象方法，当一个类中有抽象方法的时候，这个类一定要被定义成抽象类。</p>
<p>抽象类中也可以没有抽象方法。</p>
<p>抽象类除了有抽象方法，其它的与普通的类没什么区别。</p>
<p>当抽象类作为父类被子类继承时，子类必须实现抽象类父类中的抽象方法，如果没实现的话，则必须将子类也定义为抽象类，父类不为抽象类时，子类也可以为抽象类。</p>
<p>抽象类不能用new操作符来初始化，但是可以定义它的构造方法</p>
<hr>
<p><strong>接口</strong></p>
<p>接口是一种与类相似的结构，只包含常量和抽象方法，即接口中出现的数据是常量，默认为public static final定义的，方法默认为abstract，可以不写。</p>
<p>一个接口可以扩展一个或多个接口。</p>
<p>一个类只能继承一个类，但是能实现多个接口，从而实现多继承。</p>
<p>接口也不能用new操作符来初始化。</p>
<hr>
<p><strong>区别</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>变量</th>
<th>构造方法</th>
<th>方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>抽象类</td>
<td>无限制</td>
<td>子类通过构造方法链调用构造方法，抽象类不能用new操作符实例化</td>
<td>无限制</td>
</tr>
<tr>
<td>接口</td>
<td>所有的变量必须是public static final的</td>
<td>没有构造方法，接口不能用new操作符实例化</td>
<td>所有的方法必须是公共的抽象实例方法</td>
</tr>
</tbody>
</table>
<hr>
<p><strong>设计指南</strong></p>
<p>抽象类和接口都是用来明确多个对象的共同特征的。一般来说，详细描述父子关系的强是关系（strong is-a relationship）应该用类建模。例如，因为公历是一种日历，所以，类java.util.GregorianCalendar和java.util.Calendar是用类继承建模的。弱是关系（weak is-a relationship）也称为类属关系（is-kind-of relationship），它表明对象拥有某种属性。弱是关系可以用接口来建模。例如，所有的字符串都是可比较的，因此，String类实现Comparable接口。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lequsun.com/java/java_interface/" data-id="cixwzd9me0000zcfn51kpz4t2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-myeclipse_project" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/tool/myeclipse_project/" class="article-date">
  <time datetime="2016-05-19T15:10:08.000Z" itemprop="datePublished">2016-05-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/tool/">tool</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/tool/myeclipse_project/">MyEclipse 2014 Java Project转Web Project</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>SVN上check下来一段代码，发现无法部署到Tomcat，原因是该项目为Java Project，应转为Web Project，尝试方法如下：</strong></p>
<h6 id="1、项目上右击，如图选择"><a href="#1、项目上右击，如图选择" class="headerlink" title="1、项目上右击，如图选择"></a>1、项目上右击，如图选择</h6><p><img src="/pic/myeclipse_project_step_1.png" alt="Step 1" title="step 1"></p>
<h6 id="2、选中Dynamic-Web-Module和Java，点OK，Javascript默认已选中，这样就可以部署到Tomcat了，如图："><a href="#2、选中Dynamic-Web-Module和Java，点OK，Javascript默认已选中，这样就可以部署到Tomcat了，如图：" class="headerlink" title="2、选中Dynamic Web Module和Java，点OK，Javascript默认已选中，这样就可以部署到Tomcat了，如图："></a>2、选中Dynamic Web Module和Java，点OK，Javascript默认已选中，这样就可以部署到Tomcat了，如图：</h6><p><img src="/pic/myeclipse_project_step_2.png" alt="Step 2" title="step 2"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lequsun.com/tool/myeclipse_project/" data-id="cixwzd9ne000bzcfnmqchrs8t" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Eclipse/">Eclipse</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MyEclipse/">MyEclipse</a></li></ul>

    </footer>
  </div>
  
</article>


  

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Concurrency/">Concurrency</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Eclipse/">Eclipse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hibernate/">Hibernate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyEclipse/">MyEclipse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Set/">Set</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Data-JPA/">Spring Data JPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/session/">session</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Concurrency/" style="font-size: 10px;">Concurrency</a> <a href="/tags/Eclipse/" style="font-size: 10px;">Eclipse</a> <a href="/tags/Hibernate/" style="font-size: 10px;">Hibernate</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/MyEclipse/" style="font-size: 10px;">MyEclipse</a> <a href="/tags/Set/" style="font-size: 10px;">Set</a> <a href="/tags/Spring-Data-JPA/" style="font-size: 10px;">Spring Data JPA</a> <a href="/tags/session/" style="font-size: 10px;">session</a> <a href="/tags/socket/" style="font-size: 10px;">socket</a> <a href="/tags/spring/" style="font-size: 10px;">spring</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/java/ConcurrentHashMap/">ConcurrentHashMap，synchronizedMap分析比较</a>
          </li>
        
          <li>
            <a href="/spring/jpa_name_strategy/">Spring Data JPA中设置实体驼峰类型字段名到数据库下划线类型字段的映射</a>
          </li>
        
          <li>
            <a href="/spring/java_spring_session/">使用spring session时，关于session的共享设置</a>
          </li>
        
          <li>
            <a href="/java/java_socket/">Java中关于socket的学习</a>
          </li>
        
          <li>
            <a href="/java/java_interface/">Java中的抽象类与接口</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Leqi Sun<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>